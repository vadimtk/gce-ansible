{%- set clusteraddr = hostvars[groups['node'][0]][networkinterface]['ipv4']['address'] if inventory_hostname != groups['node'][0] else '' -%}
[mysqld]

datadir={{ mountdir }}/{{ mysqldir }}
user=mysql
socket=/tmp/mysql.sock
log-error=error.log

#  master_info_repository = TABLE
#  relay_log_info_repository = TABLE

#  binlog_checksum = NONE
#  log_slave_updates = ON

log_bin = binlog
relay_log=relay
sync_binlog=0
binlog_format = ROW
binlog_row_image=MINIMAL
server_id = {{ ansible_play_hosts.index(inventory_hostname) + 1 }}

  query_cache_type=0
  query_cache_size=0

  query_cache_type = 0
  query_cache_size = 0
 
# general
  table_open_cache = 200000
  table_open_cache_instances=64
  back_log=3500
  max_connections=4000

# files
  innodb_file_per_table
  innodb_log_file_size=10G
  innodb_log_files_in_group=2
  innodb_open_files=4000

# buffers
  innodb_buffer_pool_size= {{ bufferpool }}
  innodb_buffer_pool_instances=8
  innodb_log_buffer_size=64M

default_storage_engine=InnoDB

innodb_flush_log_at_trx_commit  = 1
innodb_doublewrite=1
innodb_flush_method             = O_DIRECT
innodb_file_per_table           = 1
innodb_autoinc_lock_mode=2
innodb_io_capacity=2000
innodb_io_capacity_max=4000


bind_address = 0.0.0.0

wsrep_slave_threads=16

wsrep_node_address="{{ hostvars[inventory_hostname][networkinterface]['ipv4']['address'] }}"
wsrep_cluster_name="{{ cluster_name }}"
wsrep_cluster_address=gcomm://{{ clusteraddr }}

# ansible_play_hosts[0] | map('extract', hostvars, [networkinterface, 'ipv4', 'address'])|list|join(',') if inventory_hostname != ansible_play_hosts[0] else "" 


#wsrep_provider="{{ installdir }}/{{ mysqlbin }}/lib/libgalera_smm.so"
wsrep_on=ON
wsrep_provider="{{ installdir }}/{{ mysqlbin }}/lib/galera/libgalera_smm.so"
#wsrep_provider="/opt/vadim/servers/mariadb-10.4.3-linux-glibc_214-x86_64/lib/galera/libgalera_smm.so"

#wsrep_sst_method=mariabackup
#wsrep_sst_auth="root:"


