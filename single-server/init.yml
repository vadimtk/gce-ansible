---
- hosts: mysql-node
  remote_user: "{{ osuser }}"
  become: yes
  become_user: root
  gather_facts: false
  vars_files:
    - mysql_nodes.yml

  tasks:

    - name: Create  ext4 filesystem
      filesystem:
        fstype: ext4
        dev: "{{ disk }}"
        force: no
        opts: -E lazy_itable_init=0,lazy_journal_init=0,discard

    - name: Mount FS
      mount:
        path: "{{ mountdir }}"
        src: "{{ disk }}"
        fstype: ext4
        opts: discard
        state: mounted

    - name: copy gpgkey
      copy:
        src: gpgkey
        dest: /tmp
        owner: root
        mode: 644
      when: server=="mysql"

    - name: import gpgkey
      shell: apt-key add /tmp/gpgkey
      when: server=="mysql"


    - name: Remove repo
      file:
        path: /etc/apt/sources.list.d/repo_mysql_com_apt_ubuntu.list
        state: absent
      when: server=="mysql"

    - name: Install software-properties-common
      apt:
        name: software-properties-common
        state: present

    - name: Install  MySQL repo
      apt_repository:
        repo: deb http://repo.mysql.com/apt/ubuntu/ bionic "{{ mysqlver }}"
        state: present
      when: server=="mysql"

    - name: Install keys
      shell: apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8
      when: server=="mariadb"

    - name: Install  MariaDB repo
      apt_repository:
        repo: deb [arch=amd64,arm64,ppc64el] http://mirrors.syringanetworks.net/mariadb/repo/10.3/ubuntu bionic main
        state: present
      when: server=="mariadb"

    - name: Install Percona Repo
      shell: >
        wget -P /tmp https://repo.percona.com/apt/percona-release_latest.generic_all.deb
      when: server=="ps"

    - name: Install Percona Repo
      shell: >
        dpkg -i /tmp/percona-release_latest.generic_all.deb
      when: server=="ps"

    - name: Update and upgrade apt packages
      apt:
        update_cache: yes

    - name: Install MySQL
      apt:
        name: mysql-server
        state: present
      when: server=="mysql"

    - name: Install MariaDB
      apt:
        name: mariadb-server
        state: present
      when: server=="mariadb"

    - name: Install Percona Repo
      shell: >
        percona-release setup ps80
      when: server=="ps"

    - name: Install Percona Server
      apt:
        name: percona-server-server
        state: present
      when: server=="ps"

    - name: Install MySQL-python
      apt:
        name: python-mysqldb
        state: present

    - name: Stop Server
      systemd:
        name: "{{ service }}"
        state: stopped

    - name: Remove datadir
      file:
        path: "{{ mysqldir }}"
        state: "{{ item }}"
        owner: mysql
        group: mysql
      with_items:
        - absent
        - directory
      tags: removedata

    - name: Install  apparmor-utils
      apt:
        name: apparmor-utils
        state: present

    - name: Disable apparmor for mysqld
      shell: >
         aa-complain /usr/sbin/mysqld
      ignore_errors: yes
      tags: init-setup

    - name: Init datadir
      shell: >
        mysqld --no-defaults --initialize-insecure --datadir="{{ mysqldir }}" --user=mysql
      when: server=="mysql"
      tags: removedata

    - name: Init datadir
      shell: >
         mysql_install_db  --no-defaults  --datadir="{{ mysqldir }}" --user=mysql
      when: server=="mariadb"
