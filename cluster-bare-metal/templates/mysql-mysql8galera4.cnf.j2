{%- set clusteraddr = hostvars[groups['node'][0]]['ansible_facts'][networkinterface]['ipv4']['address'] if inventory_hostname != groups['node'][0] else '' -%}
[mysqld]

datadir={{ mountdir }}/{{ mysqldir }}
user=mysql
socket=/tmp/mysql.sock
log-error=error.log

ssl=0
performance_schema=OFF

#  master_info_repository = TABLE
#  relay_log_info_repository = TABLE

#  binlog_checksum = NONE
#  log_slave_updates = ON

#log_bin = binlog
#relay_log=relay
#sync_binlog=0

log_bin = binlog
relay_log=relay
sync_binlog=1000
binlog_format = ROW
binlog_row_image=MINIMAL

server_id = {{ ansible_play_hosts.index(inventory_hostname) + 1 }}

# general
  table_open_cache = 200000
  table_open_cache_instances=64
  back_log=3500
  max_connections=4000

# files
  innodb_file_per_table
  innodb_log_file_size=10G
  innodb_log_files_in_group=2
  innodb_open_files=4000

# buffers
  innodb_buffer_pool_size= {{ bufferpool }}
  innodb_buffer_pool_instances=8
  innodb_log_buffer_size=64M

default_storage_engine=InnoDB

innodb_flush_log_at_trx_commit  = 0
innodb_doublewrite=0
innodb_flush_method             = O_DIRECT
innodb_file_per_table           = 1
innodb_autoinc_lock_mode=2
innodb_io_capacity=2000
innodb_io_capacity_max=4000

loose-innodb-page-cleaners=1
innodb-flush-log-at-trx-commit=0

innodb_purge_threads=1
innodb_undo_log_truncate=OFF
innodb_write_io_threads=2
innodb_read_io_threads=2
innodb_adaptive_hash_index=OFF
innodb_change_buffering=none

#innodb_monitor_enable=all
max_prepared_stmt_count=1000000 

bind_address = 0.0.0.0

wsrep_slave_threads=16

wsrep_node_address="{{ hostvars[inventory_hostname]['ansible_facts'][networkinterface]['ipv4']['address'] }}"
wsrep_cluster_name="{{ cluster_name }}"
wsrep_cluster_address=gcomm://{{ clusteraddr }}


wsrep_provider="{{ installdir }}/{{ mysqlbin[server] }}/lib/libgalera_smm.so"

#wsrep_provider_options="gcs.fc_limit=16;evs.send_window=4;evs.user_send_window=2;gcache.size=15G;cert.optimistic_pa=NO"
wsrep_provider_options="gcs.fc_limit=16;evs.send_window=4;evs.user_send_window=2;gcache.size=15G;"

#wsrep_sst_method=xtrabackup-v2
#wsrep_sst_auth="root:"

#SET GLOBAL wsrep_provider_options="cert.optimistic_pa=NO";
#wsrep_certification_rules='OPTIMIZED'

#wsrep_sync_wait=7
wsrep_sync_wait=0

#wsrep_debug=1
log-error-verbosity=3


ssl-ca={{ mountdir }}/{{ mysqldir }}/ca.pem
ssl-cert={{ mountdir }}/{{ mysqldir }}/server-cert.pem
ssl-key={{ mountdir }}/{{ mysqldir }}/server-key.pem

[client]
socket=/tmp/mysql.sock
ssl-ca={{ mountdir }}/{{ mysqldir }}/ca.pem
ssl-cert={{ mountdir }}/{{ mysqldir }}/client-cert.pem
ssl-key={{ mountdir }}/{{ mysqldir }}/client-key.pem

